{% extends "base.html" %}
{% block title %}Envío Final del Lote #{{ lote.id }}{% endblock %}
{% block content %}
    <h1>Revisión Final del Lote #{{ lote.id }}</h1>
    <p>
        <strong>Periodo:</strong> {{ lote.anio_periodo }}-{{ "%02d".format(lote.mes_periodo) }}<br>
        <strong>Estado del Lote:</strong> <strong style="color: {% if lote.estado_lote == 'ENVIADO' %}green{% else %}blue{% endif %};">{{ lote.estado_lote }}</strong>
    </p>

    {% if lote.track_id_api %}
    <div style="background-color: #d4edda; border: 1px solid #c3e6cb; padding: 15px; margin: 20px 0; border-radius: 5px;">
        <h3>Lote Enviado Exitosamente</h3>
        <p>Este lote ya fue enviado a Aportes en Línea. El ID de seguimiento es:</p>
        <p style="font-size: 1.2em; font-weight: bold; font-family: monospace;">{{ lote.track_id_api }}</p>
    </div>
    {% endif %}

    <div style="border: 2px solid {% if lote.estado_lote == 'ENVIADO' %}grey{% else %}#007bff{% endif %}; padding: 20px; text-align: center; border-radius: 5px;">
        <h2>
            {% if lote.estado_lote == 'ENVIADO' %}
                Acciones del Lote Enviado
            {% else %}
                ¡Lote Consolidado y Listo para Enviar!
            {% endif %}
        </h2>
        <p>Los datos de todas las fuentes han sido validados y combinados. Por favor, realiza una última revisión antes del envío final.</p>
        
        <div style="margin-top: 20px;">
            {% if json_disponible %}
                <a href="{{ url_for('view_consolidated_json', lote_id=lote.id) }}" target="_blank" style="padding: 10px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 5px; margin-right: 15px;">
                    📄 Revisar JSON Consolidado
                </a>
            {% endif %}
            
            {% if lote.estado_lote != 'ENVIADO' %}
            <form method="POST" action="{{ url_for('send_to_api', lote_id=lote.id) }}" style="display: inline;" onsubmit="return confirm('Estás a punto de enviar este lote a la DIAN. ¿Estás seguro?');">
                <button type="submit" style="padding: 15px; font-size: 1.2em; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    🚀 Enviar a Aportes en Línea
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    {% if lote.estado_lote != 'ENVIADO' %}
    <div style="margin-top: 20px; text-align: center;">
        <form method="POST" action="{{ url_for('reset_lote_status', lote_id=lote.id) }}"
              onsubmit="return confirm('¿Seguro que quieres resetear este lote?');">
            <input type="submit" value="Resetear Consolidación" style="background-color: #ffc107; color: black; border: none; padding: 8px; cursor: pointer; border-radius: 5px;">
        </form>
    </div>
    {% endif %}

    <p style="margin-top: 20px;"><a href="{{ url_for('dashboard') }}">&laquo; Volver al Dashboard</a></p>
{% endblock %}
